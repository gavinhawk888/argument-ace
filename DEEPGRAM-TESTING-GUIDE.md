# 🧪 Deepgram 语音识别 API 测试指南

本指南提供了完整的 Deepgram Nova-3 语音识别 API 测试方案，确保系统功能正常。

## 📋 测试概览

### 测试文件说明

| 文件 | 用途 | 运行命令 |
|------|------|----------|
| `verify-deepgram-setup.ts` | 环境配置验证 | `npm run verify:deepgram` |
| `test-deepgram-unit.ts` | 全面单元测试 | `npm run test:deepgram-unit` |
| `test-deepgram.ts` | 基础功能测试 | `npm run test:wav` |

## 🚀 快速开始

### 第一步：验证环境配置

```bash
npm run verify:deepgram
```

这个命令会检查：
- ✅ API 密钥配置
- ✅ 测试音频文件存在
- ✅ 项目依赖安装
- ✅ 服务文件完整
- ✅ 网络连接状况

### 第二步：运行单元测试

```bash
npm run test:deepgram-unit
```

这个命令会执行6个综合测试：

## 🧪 测试套件详情

### 1. 基础转录功能测试
**目标**: 验证基本的语音转文字功能

**检查项目**:
- 返回数据结构完整性
- 转录文本非空
- 置信度在合理范围 (0-1)
- 语言检测数组格式正确

**预期结果**:
```
✅ 基础转录功能测试 (1500-3000ms)
  📝 转录结果: "测试语音内容"
  🎯 置信度: 0.9234
  🌐 检测语言: zh, en
```

### 2. 多语言混合识别测试
**目标**: 验证中英文混合语音的识别能力

**检查项目**:
- 单词级语言标识准确性
- 时间戳数据完整性
- 语言分布统计
- 数据格式规范性

**预期结果**:
```
✅ 多语言混合识别测试 (1200-2500ms)
  📊 单词数量: 12
  🏷️ 语言分布: { zh: 8, en: 4 }
```

### 3. 性能基准测试
**目标**: 验证系统性能符合预期

**性能指标**:
- 处理时间 < 10秒
- 置信度 > 0.5
- 速度比率（处理时间/音频时长）

**预期结果**:
```
✅ 性能基准测试 (1800ms)
  ⏱️ 处理时间: 1800ms
  🎯 置信度: 0.9156
  🚀 速度比率: 0.45x
```

### 4. 错误处理测试
**目标**: 验证异常情况的处理能力

**测试场景**:
- 空音频数据处理
- 无效音频格式处理
- 网络连接异常处理

**预期结果**:
```
✅ 错误处理测试 (200-500ms)
  ✅ 空音频错误处理正常: 音频数据为空
  ✅ 无效音频处理正常
```

### 5. API密钥验证测试
**目标**: 验证API认证机制

**测试场景**:
- 无效API密钥处理
- 认证错误响应

**预期结果**:
```
✅ API密钥验证测试 (800-1200ms)
  ✅ API密钥验证正常: Deepgram API 错误: 401 Unauthorized
```

### 6. 数据格式验证测试
**目标**: 验证返回数据的完整性和准确性

**检查项目**:
- 时间戳递增顺序
- 语言代码格式 (zh/en/...)
- 单词内容非空
- 数据结构一致性

**预期结果**:
```
✅ 数据格式验证测试 (1500ms)
  ✅ 数据格式验证通过 (12个单词)
```

## 📊 测试报告示例

### 成功测试报告
```
📊 测试报告
============================================================
📈 总体结果: 6/6 通过 (100.0%)

⏱️ 执行时间:
  ✅ 基础转录功能测试: 1789ms
  ✅ 多语言混合识别测试: 1654ms
  ✅ 性能基准测试: 1823ms
  ✅ 错误处理测试: 456ms
  ✅ API密钥验证测试: 987ms
  ✅ 数据格式验证测试: 1678ms

🕒 总执行时间: 8387ms

🎉 所有测试通过！Deepgram API 工作正常。
```

### 部分失败报告
```
📊 测试报告
============================================================
📈 总体结果: 4/6 通过 (66.7%)

❌ 失败的测试:
  • API密钥验证测试: DEEPGRAM_API_KEY 未在环境变量中配置
  • 基础转录功能测试: Deepgram服务未初始化

⏱️ 执行时间:
  ❌ 基础转录功能测试: 123ms
  ✅ 多语言混合识别测试: 1654ms
  ✅ 性能基准测试: 1823ms
  ✅ 错误处理测试: 456ms
  ❌ API密钥验证测试: 98ms
  ✅ 数据格式验证测试: 1678ms

🕒 总执行时间: 5832ms

⚠️ 部分测试失败，请检查配置和网络连接。
```

## 🔧 故障排除

### 常见问题及解决方案

#### 1. API密钥配置问题
```
错误: DEEPGRAM_API_KEY 未在环境变量中配置
```
**解决方案**:
1. 在项目根目录创建 `.env.local` 文件
2. 添加内容：`DEEPGRAM_API_KEY=你的真实API密钥`
3. 重新运行测试

#### 2. 测试音频文件缺失
```
错误: 测试音频文件不存在: test3.wav
```
**解决方案**:
1. 确保 `test3.wav` 文件在项目根目录
2. 或者使用其他支持的格式：`test.wav`, `test.webm`, `test.mp3`

#### 3. 网络连接问题
```
错误: 无法连接到 Deepgram API
```
**解决方案**:
1. 检查网络连接
2. 确认防火墙设置
3. 验证代理配置

#### 4. 依赖安装问题
```
错误: 未安装 @deepgram/sdk
```
**解决方案**:
```bash
npm install @deepgram/sdk
```

## 🎯 测试最佳实践

### 1. 测试音频准备
- **格式**: WAV, WebM, MP3, M4A
- **时长**: 5-30秒为最佳
- **内容**: 包含中英文混合内容效果更好
- **质量**: 清晰录音，避免背景噪音

### 2. 测试频率建议
- **部署前**: 运行完整测试套件
- **代码变更后**: 运行基础功能测试
- **环境变更后**: 运行环境验证
- **定期维护**: 每周运行性能测试

### 3. 性能基准
- **响应时间**: < 5秒为优秀，< 10秒为合格
- **置信度**: > 0.8为优秀，> 0.5为合格
- **准确率**: 中英文混合内容 > 90%

## 📈 测试数据分析

### 关键指标监控

1. **处理速度趋势**
   - 跟踪平均处理时间
   - 识别性能瓶颈

2. **准确率变化**
   - 监控置信度分布
   - 分析识别质量

3. **错误频率**
   - 统计失败率
   - 分类错误类型

### 测试结果记录
建议保存测试结果用于：
- 性能趋势分析
- 问题追踪调试
- 系统优化决策

## 🚀 高级测试场景

### 1. 压力测试
测试并发请求处理能力：
```bash
# 运行多个并发测试
for i in {1..5}; do npm run test:deepgram-unit & done
```

### 2. 长音频测试
使用更长的音频文件测试：
- 准备1-5分钟的音频文件
- 监控内存使用情况
- 验证时间戳准确性

### 3. 边界条件测试
- 极短音频（< 1秒）
- 静音音频
- 纯噪音音频
- 极大音频文件

---

**💡 提示**: 定期运行测试确保系统稳定，建议将测试集成到CI/CD流程中。 